<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>新概念英语 - 课文点读</title>
    <link rel="stylesheet" href="static/base.css">
    <link rel="stylesheet" href="static/lesson.css">
    <script src="static/lesson.js"></script>
    <style>
        /* Rules for hiding/showing Chinese/English text */
        #content.en-mode .cn { display: none; }
        #content.cn-mode .en { display: none; }

        /* Copied styles from lesson.css for consistency */
        #display-modes {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0 0;
        }

        #display-modes button {
            background-color: var(--container-bg);
            color: var(--text-color-dark);
            border: 1px solid var(--container-highlight);
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        #display-modes button:hover {
            background-color: var(--primary-color);
            color: var(--text-color-active);
        }

        #display-modes button.active {
            background-color: var(--primary-color);
            color: var(--text-color-active);
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
<div class="container">
    <!-- <a href="index.html"> -->
        <div class="header">
            <!-- <h1>新概念英语</h1>
            <p>New Concept English</p> -->
        </div>
    <!-- </a> -->
</div>
<div class="book-container">
    <a id="book" href="book.html">
        <header class="book-header">
            <div class="book-title">
                <h3 id="book-title"></h3>
                <hr>
                <p id="lesson-title"></p>
            </div>
        </header>
    </a>
    <hr>
    <main id="content"></main>
</div>

<div class="player-container">
    <div class="custom-player-wrapper">
        <audio id="player"></audio>
        <div class="custom-player">
            <button id="play-pause-btn" class="player-btn play"></button>
            <div class="progress-container">
                <div id="progress-bar">
                    <div id="progress"></div>
                </div>
                <div id="time-display">0:00 / 0:00</div>
            </div>
            <div class="volume-container">
                <button id="volume-btn" class="player-btn volume-high"></button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
            </div>
        </div>
        <div id="playback-modes">
            <button id="mode-ab-loop">A-B循环</button>
            <button id="set-a" style="display: none;">设置A点</button>
            <button id="set-b" style="display: none;">设置B点</button>
            <button id="mode-continuous">连续播放</button>
            <button id="mode-single-loop">单句循环</button>
            <button id="mode-single-play">单次播放</button>
            <div id="dictation-container" class="dictation-container">
                <input type="checkbox" id="dictation-mode">
                <label for="dictation-mode"></label>
                <span>听写模式</span>
            </div>
        </div>
        <div id="playback-speed">
            <button id="speed-0.5x">0.5x</button>
            <button id="speed-1x">1x</button>
            <button id="speed-1.5x">1.5x</button>
            <button id="speed-1.75x">1.75x</button>
            <button id="speed-2x">2x</button>
            <button id="speed-3x">3x</button>
        </div>
        <div id="display-modes">
            <button id="mode-bilingual">中英</button>
            <button id="mode-en">英文</button>
            <button id="mode-cn">中文</button>
        </div>
    </div>
</div>

<footer>
    <hr>
    <p>© 2025</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const hash = window.location.hash.substring(1);
    const parts = hash.split('/');
    const book = parts[0] ? parts[0].replace('NCE', '') : null;
    const lesson = parts[1] || null;

    function savePlaybackHistory(currentTime) {
        const title = document.getElementById('lesson-title').textContent;
        if (!book || !lesson || !title) return;

        let history = JSON.parse(localStorage.getItem('ncePlaybackHistory') || '[]');

        // Remove existing entry for this lesson to move it to the top
        history = history.filter(item => !(item.book === book && item.lesson === lesson));

        // Add new entry to the beginning
        history.unshift({ book, lesson, title, lastPosition: currentTime, timestamp: Date.now() });

        // Keep only the last 10 items
        if (history.length > 10) {
            history.pop();
        }

        localStorage.setItem('ncePlaybackHistory', JSON.stringify(history));
    }

    const player = document.getElementById('player');
    let lastUpdateTime = 0;

    player.addEventListener('loadedmetadata', () => {
        const history = JSON.parse(localStorage.getItem('ncePlaybackHistory') || '[]');
        const currentLessonEntry = history.find(item => item.book === book && item.lesson === lesson);

        if (currentLessonEntry && currentLessonEntry.lastPosition) {
            player.currentTime = currentLessonEntry.lastPosition;
        }
        // Save initial position
        savePlaybackHistory(player.currentTime);
    });

    player.addEventListener('timeupdate', () => {
        const now = Date.now();
        // Update history every 5 seconds to avoid excessive writes
        if (now - lastUpdateTime > 5000) {
            savePlaybackHistory(player.currentTime);
            lastUpdateTime = now;
        }
    });

    const content = document.getElementById('content');
    const displayModesContainer = document.getElementById('display-modes');

    function applyDisplayMode(mode) {
        if (!mode) return;
        content.classList.remove('bilingual-mode', 'en-mode', 'cn-mode');
        content.classList.add(mode);

        for (const child of displayModesContainer.children) {
            child.classList.remove('active');
        }
        
        const modeName = mode.split('-')[0];
        const activeButton = document.getElementById(`mode-${modeName}`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    displayModesContainer.addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON') return;

        const modeName = e.target.id.replace('mode-', ''); // bilingual, en, cn
        const modeClass = `${modeName}-mode`;
        
        applyDisplayMode(modeClass);
        localStorage.setItem('displayMode', modeClass);
    });

    // Load saved display mode
    const savedDisplayMode = localStorage.getItem('displayMode') || 'bilingual-mode';
    applyDisplayMode(savedDisplayMode);
});
</script>

</body>
</html>